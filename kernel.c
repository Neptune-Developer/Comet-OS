#include <stdint.h>
#include <stddef.h>
#include "vm_pages.h"

#define UART_BASE 0x09000000
#define UART_DR   (UART_BASE + 0x00)
#define UART_FR   (UART_BASE + 0x18)
#define UART_IBRD (UART_BASE + 0x24)
#define UART_FBRD (UART_BASE + 0x28)
#define UART_LCRH (UART_BASE + 0x2C)
#define UART_CR   (UART_BASE + 0x30)

#define DEFAULT_FB_BASE 0xA0000000
#define DEFAULT_FB_WIDTH 1024
#define DEFAULT_FB_HEIGHT 768

struct fb_info {
    uint64_t base_addr;
    uint32_t width;
    uint32_t height;
    uint32_t pitch;
    uint32_t bpp;
    uint32_t size;
};

static struct fb_info fb;

static void mmio_write(uint64_t addr, uint32_t value) {
   *(volatile uint32_t*)addr = value;
}

static uint32_t mmio_read(uint64_t addr) {
   return *(volatile uint32_t*)addr;
}

static void uart_init(void) {
   vm_map(UART_BASE, UART_BASE, PROT_READ | PROT_WRITE);
   mmio_write(UART_CR, 0);
   mmio_write(UART_IBRD, 26);
   mmio_write(UART_FBRD, 3);
   mmio_write(UART_LCRH, 0x70);
   mmio_write(UART_CR, 0x301);
}

static void uart_putchar(char c) {
   while (mmio_read(UART_FR) & (1 << 5));
   mmio_write(UART_DR, c);
}

static void uart_puts(const char* str) {
   while (*str) {
       if (*str == '\n') {
           uart_putchar('\r');
       }
       uart_putchar(*str++);
   }
}

static int fb_detect(void) {
    fb.base_addr = DEFAULT_FB_BASE;
    fb.width = DEFAULT_FB_WIDTH;
    fb.height = DEFAULT_FB_HEIGHT;
    fb.pitch = fb.width * 4;
    fb.size = fb.pitch * fb.height;
    fb.bpp = 32;
    return 0;
}

static uint8_t font[128][16] = {
    [' '] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['0'] = {0x00,0x00,0x3C,0x66,0x6E,0x76,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['1'] = {0x00,0x00,0x18,0x18,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    ['2'] = {0x00,0x00,0x3C,0x66,0x06,0x0C,0x30,0x60,0x60,0x60,0x60,0x7E,0x00,0x00,0x00,0x00},
    ['3'] = {0x00,0x00,0x3C,0x66,0x06,0x06,0x1C,0x06,0x06,0x06,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['a'] = {0x00,0x00,0x00,0x00,0x3C,0x06,0x3E,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00},
    ['b'] = {0x00,0x00,0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    ['c'] = {0x00,0x00,0x00,0x00,0x3C,0x66,0x60,0x60,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['d'] = {0x00,0x00,0x06,0x06,0x3E,0x66,0x66,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00},
    ['e'] = {0x00,0x00,0x00,0x00,0x3C,0x66,0x66,0x7E,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['f'] = {0x00,0x00,0x1C,0x36,0x30,0x30,0x7C,0x30,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    ['g'] = {0x00,0x00,0x00,0x00,0x3E,0x66,0x66,0x66,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00},
    ['h'] = {0x00,0x00,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    ['i'] = {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    ['j'] = {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,0x00},
    ['k'] = {0x00,0x00,0x60,0x60,0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x66,0x00,0x00,0x00,0x00},
    ['l'] = {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    ['m'] = {0x00,0x00,0x00,0x00,0x66,0xFF,0xDB,0xDB,0xDB,0xDB,0xDB,0xDB,0x00,0x00,0x00,0x00},
    ['n'] = {0x00,0x00,0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    ['o'] = {0x00,0x00,0x00,0x00,0x3C,0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00},
    ['p'] = {0x00,0x00,0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x00,0x00},
    ['q'] = {0x00,0x00,0x00,0x00,0x3E,0x66,0x66,0x66,0x66,0x66,0x3E,0x06,0x06,0x06,0x00,0x00},
    ['r'] = {0x00,0x00,0x00,0x00,0x6C,0x76,0x66,0x60,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00},
    ['s'] = {0x00,0x00,0x00,0x00,0x3E,0x60,0x60,0x3C,0x06,0x06,0x06,0x7C,0x00,0x00,0x00,0x00},
    ['t'] = {0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    ['u'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00},
    ['v'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x00,0x00,0x00,0x00},
    ['w'] = {0x00,0x00,0x00,0x00,0x63,0x63,0x6B,0x6B,0x6B,0x36,0x36,0x36,0x00,0x00,0x00,0x00},
    ['x'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    ['y'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00},
    ['z'] = {0x00,0x00,0x00,0x00,0x7E,0x06,0x0C,0x18,0x30,0x60,0x60,0x7E,0x00,0x00,0x00,0x00},
    ['-'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['@'] = {0x00,0x00,0x3C,0x66,0x66,0x6E,0x6E,0x60,0x62,0x60,0x60,0x3C,0x00,0x00,0x00,0x00},
    ['.'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    [':'] = {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    ['/'] = {0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00},
    ['#'] = {0x00,0x00,0x36,0x36,0x7F,0x36,0x36,0x36,0x7F,0x36,0x36,0x36,0x00,0x00,0x00,0x00},
    ['~'] = {0x00,0x00,0x00,0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

static void fb_init(void) {
   for (uint64_t offset = 0; offset < fb.size; offset += PAGE_SIZE) {
       vm_map(fb.base_addr + offset, fb.base_addr + offset, PROT_READ | PROT_WRITE);
   }
}

static void fb_clear(uint32_t color) {
   volatile uint32_t* fbptr = (volatile uint32_t*)fb.base_addr;
   for (uint32_t i = 0; i < fb.width * fb.height; i++) {
       fbptr[i] = color;
   }
}

static void fb_putchar(char c, uint32_t x, uint32_t y, uint32_t fg, uint32_t bg) {
   uint8_t* glyph = font[(uint8_t)c];
   volatile uint32_t* fbptr = (volatile uint32_t*)fb.base_addr;
   
   for (int row = 0; row < 16; row++) {
       for (int col = 0; col < 8; col++) {
           uint32_t color = (glyph[row] & (1 << (7 - col))) ? fg : bg;
           if (x + col < fb.width && y + row < fb.height) {
               fbptr[(y + row) * fb.width + (x + col)] = color;
           }
       }
   }
}

static void fb_puts(const char* str, uint32_t x, uint32_t y, uint32_t fg, uint32_t bg) {
   uint32_t cur_x = x;
   uint32_t cur_y = y;
   while (*str) {
       if (*str == '\n') {
           cur_y += 16;
           cur_x = x;
       } else {
           fb_putchar(*str, cur_x, cur_y, fg, bg);
           cur_x += 8;
       }
       str++;
   }
}

void kernel_main(void) {
   vm_init();
   set_page_table_base(0x1000);
   
   static void uart_init(void) {
   vm_map(UART_BASE, UART_BASE, PROT_READ | PROT_WRITE);
   mmio_write(UART_CR, 0);
   mmio_write(UART_IBRD, 26);
   mmio_write(UART_FBRD, 3);
   mmio_write(UART_LCRH, 0x70);
   mmio_write(UART_CR, 0x301);
   asm volatile("dmb ish" ::: "memory");
}

   fb_detect();
   fb_init();
   fb_clear(0x000000);
   fb_puts("Hello From Comet OS\n", 10, 10, 0xFFFFFF, 0x000000);
   uart_puts("Hello from Comet OS\n");
   
   while(1) {
       asm volatile("wfi");
   }
}
